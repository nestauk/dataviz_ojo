<!DOCTYPE html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Open Jobs Observatory: Open, up-to-date and actionable insights on UK skill demands | Nesta</title>
  <meta name="description" content="The observatory contains insights from online job adverts, with a focus on the skills being requested by employers."/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" type="text/css" href="css/stylesheet.css">

  <script src="https://unpkg.com/d3@6.7.0/dist/d3.min.js"></script>
  <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>

  <!-- <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@nesta_uk" />
  <meta name="twitter:title" content="Open Jobs Observatory" />
  <meta name="twitter:description" content="Insights on skills from job adverts"/>
  <meta name="twitter:image" content="https://data-viz.nesta.org.uk/xxxx/img/twitter_image.png" />
   -->
  
</head>


<body>

  <div class="container_title">
    <div class="container_title_text">Title goes here</div>
    <div class="container_subtitle_text">Subtitle goes here</div>
    <div class="container_date">weekday, day month year</div>        
    <div class="container_author">
      <a href='https://www.nesta.org.uk/team/karlis-kanders/' target="_blank"; >Author One</a> and <a href='http://www.nesta.org.uk/users/cath-sleeman' target="_blank";>Author Two</a>
    </div>        
  </div>


  <div class="container_parent">

    <div class="container_left_col">
      <div id="chart_m"></div> 
    </div>  

    <div class="container_text">  

      <div class="text_content">
        
        <div class="introduction">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. </div> 

        <h2>Heading goes here</h2>       
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>

        <h3>How do skill demands vary across the UK?</h3>       

      </div>
      
      <div id="chart"></div> 

      <div class="text_content">
        
        <h2>Heading goes here</h2>       
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>

        <h3>Which skills are required in the most advertised occupations?</h3>       

      </div>

      <div id="chart_2"></div> 

      <div class="text_content">
        
        <h2>Heading goes here</h2>       
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>

        <h3>What salaries are associated with the most in-demand skills?</h3>       

      </div>

      <div id="chart_3"></div> 

      <div class="text_content">
        
        <h2>Heading goes here</h2>       
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>

      </div>

    </div>

  </div>

  
  <div class="app-footer">
    <div class="app-footer__container">
      <div class="app-footer__icons">

        <div class="footer-links">
          <div class="footer-links__container">
            <div class="footer-link-item">
              <a class="footer-link-item__link" href="https://www.nesta.org.uk/press/"
                  target="_parent">Press</a> <slot></slot>
              <a class="footer-link-item__link" href="https://www.nesta.org.uk/jobs/"
                  target="_parent">Jobs</a> <slot></slot>
              <a class="footer-link-item__link" href="https://www.nesta.org.uk/privacy/"
                  target="_parent">Privacy</a> <slot></slot>
              <a class="footer-link-item__link" href="https://www.nesta.org.uk/cookies/"
                  target="_parent">Cookies</a> <slot></slot>
              <a class="footer-link-item__link" href="https://www.nesta.org.uk/terms-use/"
                  target="_parent">Terms of use</a> <slot></slot>
              <a class="footer-link-item__link" href="https://www.nesta.org.uk/contact-us/"
                  target="_parent">Contact us</a> <slot></slot>
            </div>
          </div>
        </div>

      </div>
      
      <div class="footer-link-item">
          Â© 2021 Nesta Nesta is a registered charity in England and Wales 1144091 and Scotland SC042833. Our main address is 58 Victoria Embankment, London, EC4Y 0DS. You can reach us by phone on 020 7438 2500 or drop us a line at information@nesta.org.uk.
      </div>

      <div class="footer-link-item">
          All our work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License, unless it says otherwise. We hope you find it useful.
      </div>

    </div>
  </div>


</body>

<!-- Global site tag (gtag.js) - Google Analytics -->
<!--     <script async src="https://www.googletagmanager.com/gtag/js?id=UA-1360665-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-1360665-16');
    </script>
 -->

<script>

//////////////////////  
// MARGIN          //
//////////////////////  
 
let chartSVG_m = d3.select("#chart_m").append("svg")
let svg_m = chartSVG_m.append("g")

//////////////////////  
// LOCATIONS        //
//////////////////////  
 
let chartSVG = d3.select("#chart").append("svg")
let svg = chartSVG.append("g")

//////////////////////  
// OCCUPATIONS      //
//////////////////////  

let chartSVG_2 = d3.select("#chart_2").append("svg")
let svg_2 = chartSVG_2.append("g")

//////////////////////  
// SALARIES         //
//////////////////////  

let chartSVG_3 = d3.select("#chart_3").append("svg")
let svg_3 = chartSVG_3.append("g")



//////////////////////////  
// SCALES & PARAMETERS  //
//////////////////////////  

// Universals for scales
const small_width = 750
const xMin = 0; 
const xMax = 100;
const yMin = 0;
const yMax = 100;
const xScale = d3.scaleLinear().domain([xMin,xMax])
const yScale = d3.scaleLinear().domain([yMin,yMax])

// Scales for margins
const xScale_m = d3.scaleLinear().domain([xMin,xMax])
const yScale_m = d3.scaleLinear().domain([yMin,yMax])

// Scales for salaries
const xScale_s = d3.scaleLinear()
const yScale_s = d3.scaleLinear()


// Parameters for locations
let no_y_pos;
let no_y_pos_small;
let no_x_pos;
let no_x_pos_small;
// Proportion of each area (in each direction) that will be taken up by
// stacked bar chart
const prop_space_x = 0.95
const prop_space_y = 0.9

// Parameters for occupations
let sankey;

// Parameters for salaries
let no_salaries;
let highest_salary_shown;
let lowest_salary_shown;
let rotate_adj;
let salary_rings = [10, 20,30,40,50]

// Parameters for margins
const radius_circles = 20
let no_skills;

// Colours
const color_skills_range = [d3.rgb(255,90,0), '#EB0085',d3.rgb(255,184,25), "#24C7C9",
 "#B4D905"]
const color_skills_domain = ["broad_skill_group_1", "broad_skill_group_2", "broad_skill_group_3", "broad_skill_group_4", "broad_skill_group_5"]
const color_skills = d3.scaleOrdinal().domain(color_skills_domain).range(color_skills_range)
const color_nuts2_names = '#000000'
const color_nuts2_names_bground = '#FFFFFF' 

const color_skills_names = '#575757'
const color_skills_names_bground = '#FFFFFF'

const color_occupation_rect = '#000000'
const color_occupation_skill_names = '#000000'
const color_occupation_skill_names_bground = '#FFFFFF'

const color_salary_rings = '#000000'
const color_salary_names = '#000000'
const color_salary_names_bground = '#FFFFFF'
const color_salary_axis = '#FFFFFF'
const color_salary_axis_bground = '#000000'


//////////////////////  
// DEFINE SHAPES    //
//////////////////////  

// Load data
d3.json("data/data.json")
  .then(setup)

// Define shapes
function setup(data){

  //////////////////////  
  // LOCATIONS        //
  //////////////////////  

  // Number of x and y positions in the map
  let all_x_pos = data['locations'].map(function(d,i) { return d.x_pos})
  no_x_pos = all_x_pos.filter((item, i, ar) => ar.indexOf(item) === i).length;
  let all_x_pos_small = data['locations'].map(function(d,i) { return d.x_pos_small})
  no_x_pos_small = all_x_pos_small.filter((item, i, ar) => ar.indexOf(item) === i).length;
  let all_y_pos = data['locations'].map(function(d,i) { return d.y_pos})
  no_y_pos = all_y_pos.filter((item, i, ar) => ar.indexOf(item) === i).length;
  let all_y_pos_small = data['locations'].map(function(d,i) { return d.y_pos_small})
  no_y_pos_small = all_y_pos_small.filter((item, i, ar) => ar.indexOf(item) === i).length;

  // Group for each NUTS2 area       
  svg.selectAll(".nuts2_group")
    .data(data['locations'])
    .enter()
    .append("g")
    .attr("class", "nuts2_group")

  // NUTS 2 areas rectangles
  svg.selectAll(".nuts2_group").selectAll('.nuts2_skills')
  .data(function(d,i) { return d.skills })
  .enter().append('rect')
  .attr('class', 'nuts2_skills')
  .style("fill",function(d,i){ return color_skills(d.broad_skill_group) })
  .style("stroke",function(d,i){ return color_skills(d.broad_skill_group) })
  .style('mix-blend-mode', 'multiply')  
  .attr('rx', '3px')
  .attr('ry', '3px')

  // NUTS 2 area names background - wide screen
  svg.selectAll(".nuts2_group").selectAll('.nuts2_names_long_bground')
  .data(function(d,i) { return d.names_long })
  .enter().append('text')
  .attr('class', 'nuts2_names_long_bground')
  .text(function(d,i) { return d[0].toUpperCase()})
  .style('text-anchor', 'middle')
  .style('stroke', color_nuts2_names_bground)

  // NUTS 2 area names - wide screen
  svg.selectAll(".nuts2_group").selectAll('.nuts2_names_long')
  .data(function(d,i) { return d.names_long })
  .enter().append('text')
  .attr('class', 'nuts2_names_long')
  .text(function(d,i) { return d[0].toUpperCase()})

  // NUTS 2 area names background - narrow screen
  svg.selectAll(".nuts2_group").selectAll('.nuts2_names_short_bground')
  .data(function(d,i) { return d.names_short })
  .enter().append('text')
  .attr('class', 'nuts2_names_short_bground')
  .text(function(d,i) { return d[0].toUpperCase()})
  .style('stroke', color_nuts2_names_bground)

  // NUTS 2 area names - narrow screen
  svg.selectAll(".nuts2_group").selectAll('.nuts2_names_short')
  .data(function(d,i) { return d.names_short })
  .enter().append('text')
  .attr('class', 'nuts2_names_short')
  .text(function(d,i) { return d[0].toUpperCase()})

  // Style of NUTS 2 area names
  svg.selectAll(".nuts2_group").selectAll('.nuts2_names_long, .nuts2_names_long_bground,.nuts2_names_short, .nuts2_names_short_bground')
  .style('text-anchor', 'middle')
  .style('fill', color_nuts2_names)
  .style('font-size', '10px')
  .style('font-weight', 'bold')


  //////////////////////  
  // OCCUPATIONS      //
  //////////////////////  

  // To adjust sankey in resize() 
  window.data_occupations = data['occupations'];

  sankey = d3.sankey()
  .nodeId(d => d.name)
  .nodeSort(null)
  .nodeWidth(5)
  .nodePadding(15)
  .extent([[1, 5], [700 - 1, 800 - 5]]);

  data_reformatted = sankey({
    nodes: data['occupations']['nodes'],
    links: data['occupations']['links'] 
  }); 

  // Black rectangles
  svg_2.selectAll('.occupation_skill_rect')
  .data(data_reformatted['nodes'])
  .enter().append('rect')
  .attr('class', 'occupation_skill_rect')
  .attr("fill", color_occupation_rect)
  .attr('rx', '4px')
  .attr('ry', '4px')

  // Paths
  svg_2.selectAll(".occupation_skill_links")
  .data(data_reformatted['links'])
  .enter().append("path")
  .attr('class', 'occupation_skill_links')
  .style("stroke", function(d,i) { return color_skills(d.target.name)}) 
  .style("fill", 'none')
  .style("mix-blend-mode", "multiply");

  // Background to occupation and skill labels
  svg_2.selectAll('.occupation_skill_text_bground')
  .data(data_reformatted['nodes'])
  .enter().append('text')
  .attr('class', 'occupation_skill_text_bground')
  .style('fill', color_occupation_skill_names_bground)  
  .style('stroke', color_occupation_skill_names_bground)  
  .text(function(d,i) { return d.name.toUpperCase()})

  // Occupation and skill labels
  svg_2.selectAll('.occupation_skill_text')
  .data(data_reformatted['nodes'])
  .enter().append('text')
  .attr('class', 'occupation_skill_text')
  .style('fill', color_occupation_skill_names)  
  .text(function(d,i) { return d.name.toUpperCase()})
      
  // Occupation and skill labels - styles
  svg_2.selectAll('.occupation_skill_text, .occupation_skill_text_bground')
  .style('font-size', '10px')
  .style('font-weight', 'bold')
  .style('text-anchor', function(d,i) { return d.targetLinks.length>0 ? 'end' : 'start' })
  .attr('dy', '-0.2em')



  //////////////////////  
  // SALARIES         //
  //////////////////////  

  // Scales for salaries
  xScale_s.domain([xMin,xMax])
  
  // Set parameter values
  // Add 5 to no_salaries to leave space for the salary_rings_text
  no_salaries = data['salaries'].length+5
  // Rotate the chart to ensure the min and max salaries straddle the top of the chart
  rotate_adj = 0.225*no_salaries
  // Domain for salary scale (yScale_s)
  // -5 and +3 to give extra space
  let lowest_salary = Math.min.apply(Math, data['salaries'].map(function(d,i) { return d.salaries.lower_bound.lower_q }))
  lowest_salary_shown = Math.min(salary_rings[0],lowest_salary)-5
  let highest_salary = Math.max.apply(Math, data['salaries'].map(function(d,i) { return d.salaries.upper_bound.upper_q }))
  highest_salary_shown = Math.max(highest_salary,salary_rings[salary_rings.length-1])+3
  yScale_s.domain([lowest_salary_shown,highest_salary_shown])

  // Rings to indicate salaries
  svg_3.selectAll('.salary_rings')
  .data(salary_rings).enter().append('circle')
  .attr('class', 'salary_rings')
  .style("fill", 'transparent')
  .style('stroke', color_salary_rings)
  .style('stroke-dasharray', '5,5')

  // Lower quartile of lower bound to median of lower bound
  svg_3.selectAll('.lower_bounds')
  .data(data['salaries']).enter().append('rect')
  .attr('class', 'lower_bounds')
  .style('opacity', 0.25)

  // Median of lower bound to median of upper bound
  svg_3.selectAll('.medians')
  .data(data['salaries']).enter().append('rect')
  .attr('class', 'medians')

  // Median of upper bound to upper quartile of upper bound
  svg_3.selectAll('.upper_bounds')
  .data(data['salaries']).enter().append('rect')
  .attr('class', 'upper_bounds')
  .style('opacity', 0.25)

  // Lines for salaries - styles
  svg_3.selectAll('.lower_bounds, .medians, .upper_bounds')
  .style("fill",function(d,i){ return color_skills(d.broad_skill_group) })
  .attr('rx', '2px')
  .attr('ry', '2px')
  .style("mix-blend-mode", "multiply");

  // Text to indicate salary associated with each ring - background
  svg_3.selectAll('.salary_rings_text_bground')
  .data(salary_rings).enter().append('text')
  .attr('class', 'salary_rings_text_bground')
  .text(function(d,i) { return (i==salary_rings.length-1 || i==0) ? 'Â£'+d+'k per annum'.toUpperCase() : 'Â£'+d+'k'.toUpperCase()})
  .style("fill", color_salary_axis_bground)
  .style("stroke", color_salary_axis_bground)

  // Text to indicate salary associated with each ring
  svg_3.selectAll('.salary_rings_text')
  .data(salary_rings).enter().append('text')
  .attr('class', 'salary_rings_text')
  .text(function(d,i) { return (i==salary_rings.length-1 || i==0) ? 'Â£'+d+'k per annum'.toUpperCase() : 'Â£'+d+'k'.toUpperCase()})
  .style("fill", color_salary_axis)

  // Text to indicate salary associated with each ring - style
  svg_3.selectAll('.salary_rings_text, .salary_rings_text_bground')
  .style('font-size', '11px')
  .style('font-weight', 'bold')
  .style('text-anchor', 'end')

  // Names of skills - background
  svg_3.selectAll(".salary_skills_name_bground")
  .data(data['salaries']).enter()
  .append("text")
  .attr('class', 'salary_skills_name_bground')
  .text(function(d) { return d.skill_name.toUpperCase() })
  .style('fill', color_salary_names_bground)    
  .style('stroke', color_salary_names_bground) 

  // Names of skills
  svg_3.selectAll(".salary_skills_name")
  .data(data['salaries']).enter()
  .append("text")
  .attr('class', 'salary_skills_name')
  .text(function(d) { return d.skill_name.toUpperCase() })
  .style('fill', color_salary_names)  

  // Names of skills - styles
  svg_3.selectAll(".salary_skills_name, .salary_skills_name_bground")
  .style('font-size', '10px')
  .style('font-weight', 'bold')



  //////////////////////  
  // MARGIN           //
  //////////////////////

  // Parameters for margins
  no_skills = data['skills'].length  

  // Circles for skills
  svg_m.selectAll('.skills_circles')
  .data(data['skills'])
  .enter().append('circle')
  .attr('class', 'skills_circles')
  .style('fill', function(d,i) { return color_skills(d.broad_skill_group)})
  .style("mix-blend-mode", "multiply");

  // Arcs for labels
  svg_m.selectAll('.skills_arcs')
  .data(data['skills'])
  .enter().append("path")
  .attr('class', 'skills_arcs')
  .attr("fill","none")
  .attr("id", function(d,i){return "s"+i;})

  // Paths for labels
  let arcPaths = svg_m.selectAll('.arc_paths')
  .data(data['skills'])
  .enter().append("g")
  .attr('class', 'arc_paths')
  .style('font-size', '10px')
  .style('font-weight', 'bold')
  .style("text-anchor", "middle")

  // Skills labels - background
  arcPaths.append('text')
  .append("textPath")
  .attr('class', 'skills_text_bground')
  .attr("xlink:href",function(d,i){return "#s"+i;})
  .attr("startOffset",function(d,i){return "50%";})
  .text(function(d,i) { return d.skill_name.toUpperCase();})
  .style('fill', color_skills_names_bground)
  .style('stroke', color_skills_names_bground)

  // Skills labels
  arcPaths.append("text")
  .append("textPath")
  .attr("xlink:href",function(d,i){return "#s"+i;})
  .attr("startOffset",function(d,i){return "50%";})
  .text(function(d,i) { return d.skill_name.toUpperCase();})
  .style('fill', color_skills_names)

  // Title of chart
  svg_m.selectAll('.title')
  .data(['Most frequently','demanded skills'])
  .enter().append('text')
  .attr('class', 'title')
  .style('fill', color_skills_names)
  .style('text-anchor', 'middle')
  .text(function(d,i) { return d.toUpperCase() })
  .style('font-size', '12px')
  .style('font-weight', 'bold')


  // Resize function
  resize()


}


function resize() {


  //////////////////////  
  // UNIVERSAL        //
  //////////////////////  

  let width_container_parent = document.getElementsByClassName('container_parent')[0].clientWidth; 
  let bodyWidth = null
  if (width_container_parent>=1380) {
    bodyWidth = 1380*0.85
  } else if (document.body.clientWidth>1250) {
    bodyWidth = document.body.clientWidth*0.835*0.85
  } else {
    bodyWidth = document.body.clientWidth*0.95    
  }
  let width = bodyWidth*0.85  
    , margin = {top: 0, right: (bodyWidth-width)/2, bottom: bodyWidth*0, left: (bodyWidth-width)/2}
    , height = 700 

  xScale.range([0, width]);
  yScale.range([height, 0]);


  //////////////////////  
  // LOCATIONS        //
  //////////////////////  

  // SVG
  chartSVG.attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  svg.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // Positions of NUTS 2 group
  svg.selectAll('.nuts2_group').attr('transform', function(d,i) { return (width<small_width) ? 'translate('+xScale(d.x_pos_small)+','+yScale(d.y_pos_small)+')' : 'translate('+xScale(d.x_pos)+','+yScale(d.y_pos)+')'})

  // Demand by skill group
  svg.selectAll('.nuts2_group').selectAll('.nuts2_skills')
  .attr('x', function(d,i) { return (width<small_width) ?  xScale((prop_space_x*d.percent_cumulative/no_x_pos_small)-(prop_space_x*50/no_x_pos_small)) : xScale((prop_space_x*d.percent_cumulative/no_x_pos)-prop_space_x*50/no_x_pos) })  
  .attr('y', function(d,i) { return (width<small_width) ?  yScale(100+(prop_space_y*50/no_y_pos_small)) : yScale(100+(prop_space_y*50/no_y_pos))})
  .attr('width', function(d,i) { return (width<small_width) ? xScale(prop_space_x*d.percent/no_x_pos_small) : xScale(prop_space_x*d.percent/no_x_pos) })
  .attr('height', function(d,i) { return (width<small_width) ? yScale(100-(prop_space_y*100/no_y_pos_small)) : yScale(100-(prop_space_y*100/no_y_pos))})
  .style('stroke-width', function(d,i) { return xScale(0.2)})


  // NUTS 2 area names - wide screen
  svg.selectAll('.nuts2_group').selectAll('.nuts2_names_long_bground')
  .attr("dy", function(d,i) { return i+"em" })
  .style('stroke-width', function(d,i) { return xScale(0.7)})

  svg.selectAll('.nuts2_group').selectAll('.nuts2_names_long')
  .attr("dy", function(d,i) { return i+"em" })

  svg.selectAll('.nuts2_group').selectAll('.nuts2_names_long_bground, .nuts2_names_long')
  .attr('y', function(d,i) { return d[1]==1 ? '0.5em' : d[1]==2 ? '0em' : d[1]==3 ? '-0.5em' : '-1em'})
  .style('opacity', function(d,i) { return (width<small_width) ? 0 : 1})


  // NUTS 2 area names - narrow screen
  svg.selectAll('.nuts2_group').selectAll('.nuts2_names_short_bground')
  .attr("dy", function(d,i) { return i+"em" })
  .style('stroke-width', function(d,i) { return xScale(0.7)})

  svg.selectAll('.nuts2_group').selectAll('.nuts2_names_short')
  .attr("dy", function(d,i) { return i+"em" })

  svg.selectAll('.nuts2_group').selectAll('.nuts2_names_short_bground, .nuts2_names_short')
  .attr('y', function(d,i) { return d[1]==1 ? '0.5em' : d[1]==2 ? '0em' : d[1]==3 ? '-0.5em' : '-1em'})
  .style('opacity', function(d,i) { return (width<small_width) ? 1 : 0})



  //////////////////////  
  // OCCUPATIONS      //
  //////////////////////  

  // SVG
  chartSVG_2.attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  svg_2.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // Adjust sankey for width and height
  sankey.size([width, height])
  .extent([[1, 10], [width - 1, height - 10]]);

  // Adjust positions
  data_reformatted = sankey({
      nodes: data_occupations['nodes'],
      links: data_occupations['links'] 
    }); 

  // Black rectangles 
  svg_2.selectAll('.occupation_skill_rect')
  .data(data_reformatted['nodes'])
  .attr("x", function(d,i) { return d.x0})
  .attr("y", function(d,i) { return d.y0})
  .attr("width", function(d,i) { return (d.x1 - d.x0)})
  .attr("height", function(d,i) { return (d.y1 - d.y0) })

  // Background to occupation and skill labels
  svg_2.selectAll('.occupation_skill_text_bground')
  .data(data_reformatted['nodes'])
  .attr("x", function(d,i) { return d.x0})
  .attr("y", function(d,i) { return d.y0})
  .style('stroke-width', function(d,i) { return xScale(0.7)})

  // Occupation and skill labels
  svg_2.selectAll('.occupation_skill_text')
  .data(data_reformatted['nodes'])
  .attr("x", function(d,i) { return d.x0})
  .attr("y", function(d,i) { return d.y0})

  // Paths
  svg_2.selectAll(".occupation_skill_links")
  .data(data_reformatted['links'])
  .attr("d", d3.sankeyLinkHorizontal())
  .attr("stroke-width", function(d,i) { return Math.max(1, d.width) });



  //////////////////////  
  // SALARIES         //
  //////////////////////  

  // Vary the height as the chart is circular
  let height_s = width

  // Scales
  xScale_s.range([0, width]);
  yScale_s.range([0, height_s*0.5]);

  // SVG
  chartSVG_3.attr("width", width + margin.left + margin.right)
  .attr("height", height_s + margin.top + margin.bottom)
  svg_3.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // Rings to indicate salaries
  svg_3.selectAll('.salary_rings')
  .attr('cx', function(d,i) { return xScale_s(50) })
  .attr('cy', function(d,i) { return xScale_s(50)})
  .attr('r', function(d,i) { return yScale_s(d)})
  .style('stroke-width', function(d,i) { return xScale(0.15)})

  // Text to indicate salary associated with each ring - background
  svg_3.selectAll('.salary_rings_text_bground')
  .style('stroke-width', function(d,i) { return xScale(0.7)})

  // Text to indicate salary associated with each ring
  svg_3.selectAll('.salary_rings_text, .salary_rings_text_bground')
  .attr('transform', function(d,i) { 

    let x_pos = (xScale_s(50)+yScale_s(d)*Math.cos((1.5*Math.PI)))
    
    let y_pos = (xScale_s(50)+yScale_s(d)*Math.sin((1.5*Math.PI)))  

      return "translate("+x_pos+ "," + y_pos + ")" 

  })

  // Skill labels - background
  svg_3.selectAll(".salary_skills_name_bground")
  .style('stroke-width', function(d,i) { return xScale(0.7)})

  // Skill labels
  svg_3.selectAll(".salary_skills_name,.salary_skills_name_bground")
  .attr('transform', function(d,i) { 

    let x_pos = (xScale_s(50)+yScale_s(d.salaries.upper_bound.upper_q)*Math.cos((2*Math.PI)*((d.index-rotate_adj)/no_salaries)))
    
    let y_pos = (xScale_s(50)+yScale_s(d.salaries.upper_bound.upper_q)*Math.sin((2*Math.PI)*(((d.index-rotate_adj)/no_salaries))))  
 
    if (360*((d.index-rotate_adj)/no_salaries)>90) {

      return "translate("+x_pos+ "," + y_pos + ")rotate(" + ((360*((d.index-rotate_adj)/no_salaries))-180) + ")" 

    } else {

     return "translate("+x_pos+ "," + y_pos + ")rotate(" + ((360*((d.index-rotate_adj)/no_salaries))) + ")" 

    } 
  })
  .attr('dy', function(d,i) { return (360*((d.index-rotate_adj)/no_salaries)>90) ? '0.8em' : '-0.2em' })
  .style('text-anchor', function(d,i) { return (360*((d.index-rotate_adj)/no_salaries)>90) ? 'start' : 'end' })
  .style('opacity', function(d,i) { return (width<550) ? 0 : (i%5==0) ? 1 : 0})


  // Lower quartile of lower lower bound to median of lower bound
  svg_3.selectAll('.lower_bounds')
  .attr('width', function(d,i) { return yScale_s(lowest_salary_shown+d.salaries.lower_bound.median-d.salaries.lower_bound.lower_q)})  
  .attr("transform", function(d,i) { return "translate(" + (xScale_s(50)+(yScale_s(d.salaries.lower_bound.lower_q)*Math.cos((i-rotate_adj)*2*Math.PI/no_salaries))) + "," + (xScale_s(50)+(yScale_s(d.salaries.lower_bound.lower_q)*Math.sin((i-rotate_adj)*2*Math.PI/no_salaries))) + ")rotate(" +((360*(i-rotate_adj)/no_salaries))+")" })

  // Median of lower bound to median of upper bound
  svg_3.selectAll('.medians')
  .attr('width', function(d,i) { return yScale_s(lowest_salary_shown+d.salaries.upper_bound.median-d.salaries.lower_bound.median)})  
  .attr("transform", function(d,i) { return "translate(" + (xScale_s(50)+(yScale_s(d.salaries.lower_bound.median)*Math.cos((i-rotate_adj)*2*Math.PI/no_salaries))) + "," + (xScale_s(50)+(yScale_s(d.salaries.lower_bound.median)*Math.sin((i-rotate_adj)*2*Math.PI/no_salaries))) + ")rotate(" +((360*(i-rotate_adj)/no_salaries))+")" })

  // Median of upper bound to upper quartile of upper bound
  svg_3.selectAll('.upper_bounds')
  .attr('width', function(d,i) { return yScale_s(lowest_salary_shown+d.salaries.upper_bound.upper_q-d.salaries.upper_bound.median)})  
  .attr("transform", function(d,i) { return "translate(" + (xScale_s(50)+(yScale_s(d.salaries.upper_bound.median)*Math.cos((i-rotate_adj)*2*Math.PI/no_salaries))) + "," + (xScale_s(50)+(yScale_s(d.salaries.upper_bound.median)*Math.sin((i-rotate_adj)*2*Math.PI/no_salaries))) + ")rotate(" +((360*(i-rotate_adj)/no_salaries))+")" })

  // Height (effectively width) of three sets of rectangles
  svg_3.selectAll('.lower_bounds, .medians, .upper_bounds')
  .attr('height', function(d,i) { return xScale_s(1.5)})



  //////////////////////  
  // MARGIN          //
  //////////////////////  

  let bodyWidth_m = null
  if (width_container_parent>=1380) {
    bodyWidth_m = 1380*0.15
  } else if (document.body.clientWidth>1250) {
    bodyWidth_m = document.body.clientWidth*0.835*0.15
  } else {
    bodyWidth_m = document.body.clientWidth*0.95*0   
  }

  let bodyHeight_m = document.getElementsByClassName('container_text')[0].clientHeight; 

  let height_m = bodyHeight_m*0.975  
    , margin_m = {top: (bodyHeight_m-height_m), right: 0, bottom: 0, left: 0}
    , width_m = bodyWidth_m

  xScale_m.range([0, width_m]);
  yScale_m.range([height_m, 0]);

  // SVG
  chartSVG_m.attr("width", width_m)
  .attr("height", height_m + margin_m.top + margin_m.bottom)
  svg_m.attr("transform", "translate(" + margin_m.left + "," + margin_m.top + ")");
  
  // Circles for skills
  svg_m.selectAll('.skills_circles')
  .attr('cx', function(d,i) { return xScale_m(50) })
  .attr('cy', function(d,i) { return yScale_m(yMax-(100/(no_skills+1))*(i+1)) })
  .attr('r', function(d,i) { return xScale_m(radius_circles)})

  // Title of chart
  svg_m.selectAll('.title')
  .attr('x', function(d,i) { return xScale_m(50) })
  .attr('y', function(d,i) { return yScale_m(yMax) })
  .attr("dy",function(d,i) { return (i==0) ? "0.5em" : "2em"})

  // Determine position of skill labels
  function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
      let angleInRadians = (angleInDegrees-90) * Math.PI / 180.0;
      return {
          x: centerX + (radius * Math.cos(angleInRadians)),
          y: centerY + (radius * Math.sin(angleInRadians))
      };
  }

  // Determine position of skill labels
  function describeArc(x, y, radius, startAngle, endAngle){
      let start = polarToCartesian(x, y, radius, endAngle);
      let end = polarToCartesian(x, y, radius, startAngle);
      let arcSweep = endAngle - startAngle <= 180 ? "0" : "1";
      let d = [
          "M", start.x, start.y, 
          "A", radius, radius, 0, 1, 1, end.x, end.y
      ].join(" ");
      return d;       
  }

  // Skill labels 
  svg_m.selectAll('.skills_arcs')
  .attr("d", function(d,i) { 
    return describeArc(xScale_m(50), yScale_m(yMax-(100/(no_skills+1))*(i+1)), xScale_m(radius_circles*1.1), 160, -160)
  });

  // Skill labels - background
  svg_m.selectAll('.skills_text_bground')
  .style('stroke-width', function(d,i) { return xScale_m(3)})


};


// Resize
window.addEventListener("resize", function(d,i) { resize() });

 
</script>
</html>